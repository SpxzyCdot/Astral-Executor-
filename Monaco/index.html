<!DOCTYPE html>
<html>
<head>
  <title>Luau Monaco Editor with Prefix Control</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <script src="vs/loader.js"></script>
  <script>
    require.config({ paths: { 'vs': './vs' }});
  </script>
  <style>
    html, body { height: 100%; width: 100%; margin: 0; padding: 0; overflow: hidden; background: #232323; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; }
    #main-container { display: flex; flex-direction: column; height: 100%; }
    .tab-header-row { display: flex; align-items: flex-end; height: 45px; background: #202020; padding-left: 10px; }
    #tab-bar { display: flex; align-items: flex-end; }
    .flex-spacer { flex-grow: 1; height: 100%; background: #202020; }
    .tab { padding: 8px 15px; cursor: pointer; color: #ccc; font-size: 13px; background: #3f3f3f; user-select: none; display: flex; align-items: center; border-top-left-radius: 6px; border-top-right-radius: 6px; margin-right: 2px; transition: background-color 0.2s; }
    .tab:hover:not(.active) { background: #3e3e42; }
    .tab.active { background: #9b9b9b; color: #000; border-bottom: 2px solid #808080; margin-bottom: -2px; }
    .tab-close { margin-left: 10px; font-size: 16px; color: #000; }
    .tab-close:hover { color: #494949; }
    #new-tab-btn { margin-bottom: 8px; margin-left: 10px; padding: 2px 8px; background: #3c3c3c; color: #ccc; border: none; border-radius: 4px; cursor: pointer; font-size: 16px; font-weight: bold; }
    #new-tab-btn:hover { background: #5a5a5a; }
    #container { flex-grow: 1; overflow: hidden; border-top: 2px solid #808080; }
    #rename-modal-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
    #rename-modal-panel { background: #3c3c3c; color: #ccc; padding: 20px; border-radius: 5px; box-shadow: 0 4px 10px rgba(0,0,0,0.3); width: 300px; display: flex; flex-direction: column; }
    #rename-modal-input { padding: 8px; margin-bottom: 20px; border: 1px solid #5a5a5a; background: #1e1e1e; color: #fff; border-radius: 3px; font-size: 14px; }
    .modal-button { padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; font-weight: bold; font-size: 13px; }
    #rename-cancel-btn { background: #5a5a5a; color: #fff; }
    #rename-ok-btn { background: #808080; color: #fff; }
  </style>
</head>
<body>
  <div id="main-container">
    <div class="tab-header-row">
      <div id="tab-bar"></div>
      <button id="new-tab-btn">+</button>
      <div class="flex-spacer"></div>
    </div>
    <div id="container"></div>
    <div id="rename-modal-overlay">
      <div id="rename-modal-panel">
        <label for="rename-modal-input" id="rename-modal-label">Rename Script:</label>
        <input type="text" id="rename-modal-input">
        <div id="rename-modal-buttons">
          <button id="rename-cancel-btn" class="modal-button">Cancel</button>
          <button id="rename-ok-btn" class="modal-button">OK</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    let editor, tabs = [], activeTab = null, Proposals = [];
    let tabPrefix = "script_"; // Default prefix
    let tabSuffix = ".lua";

    function setTabPrefix(newPrefix) {
      tabPrefix = newPrefix || "script_";
    }

    function getNextScriptNumber() {
      let num = 1;
      while (tabs.some(t => t.name === tabPrefix + num + tabSuffix)) num++;
      return num;
    }

    function initializeProposals() {
      Proposals = [/* your proposals here */];
    }

    function getDependencyProposals() { return Proposals; }

    function saveTabsToLocalStorage() {
      localStorage.setItem("monaco-tabs", JSON.stringify(tabs.map(t => ({name: t.name, content: t.content}))));
    }

    function loadTabsFromLocalStorage() {
      const saved = localStorage.getItem("monaco-tabs");
      if (saved) {
        JSON.parse(saved).forEach(t => {
          const tab = new Tab(t.name, t.content);
          tabs.push(tab);
          document.getElementById("tab-bar").appendChild(tab.element);
        });
        tabs.length && tabs[0].activate();
      } else {
        createFirstTab();
      }
    }

    function createFirstTab() {
      const tab = new Tab(tabPrefix + "1" + tabSuffix, `print('discord.gg/getcravex')`);
      tabs.push(tab);
      document.getElementById("tab-bar").appendChild(tab.element);
      tab.activate();
      saveTabsToLocalStorage();
    }

    function createNewTab() {
      const num = getNextScriptNumber();
      const tab = new Tab(tabPrefix + num + tabSuffix, `print('discord.gg/getcravex')`);
      tabs.push(tab);
      document.getElementById("tab-bar").appendChild(tab.element);
      tab.activate();
      saveTabsToLocalStorage();
    }

    class Tab {
      constructor(name, content) {
        this.id = `tab-${Date.now()}-${Math.random().toString(36).substr(2,9)}`;
        this.name = name;
        this.content = content || "";
        this.model = monaco.editor.createModel(this.content, 'lua');
        this.element = this.createElement();
      }
      createElement() {
        const el = document.createElement("div");
        el.className = "tab";
        el.innerHTML = `${this.name}<span class="tab-close">x</span>`;
        el.onclick = e => { if (!e.target.classList.contains("tab-close")) this.activate(); };
        el.ondblclick = () => showRenameModal(this.id);
        el.querySelector(".tab-close").onclick = e => { e.stopPropagation(); this.close(); };
        return el;
      }
      activate() {
        if (activeTab === this) return;
        activeTab && (activeTab.element.classList.remove("active"), activeTab.content = editor.getValue());
        activeTab = this;
        this.element.classList.add("active");
        editor.setModel(this.model);
        const c = document.getElementById("container");
        c.style.opacity = '0.8';
        setTimeout(() => c.style.opacity = '1', 200);
        saveTabsToLocalStorage();
      }
      close() {
        if (tabs.length <= 1) return;
        const i = tabs.indexOf(this);
        tabs.splice(i, 1);
        this.element.remove();
        this.model.dispose();
        if (this === activeTab) tabs[Math.max(0, i-1)].activate();
        saveTabsToLocalStorage();
      }
      rename(newName) {
        this.name = newName.trim() || this.name;
        this.element.innerHTML = `${this.name}<span class="tab-close">x</span>`;
        this.element.querySelector(".tab-close").onclick = e => { e.stopPropagation(); this.close(); };
        saveTabsToLocalStorage();
      }
    }

    let tabToRenameId = null;
    const modal = document.getElementById('rename-modal-overlay');
    const input = document.getElementById('rename-modal-input');
    const label = document.getElementById('rename-modal-label');
    const ok = document.getElementById('rename-ok-btn');
    const cancel = document.getElementById('rename-cancel-btn');

    function showRenameModal(id) {
      const tab = tabs.find(t => t.id === id);
      if (!tab) return;
      tabToRenameId = id;
      label.textContent = `Rename "${tab.name}":`;
      input.value = tab.name;
      modal.style.display = 'flex';
      input.focus(); input.select();
      editor.updateOptions({ readOnly: true });
    }
    function hideRenameModal() {
      modal.style.display = 'none';
      tabToRenameId = null;
      editor.updateOptions({ readOnly: false });
    }
    ok.onclick = () => { if (tabToRenameId) tabs.find(t => t.id === tabToRenameId)?.rename(input.value); hideRenameModal(); };
    cancel.onclick = hideRenameModal;
    input.onkeydown = e => { if (e.key === 'Enter') ok.click(); else if (e.key === 'Escape') hideRenameModal(); };

    require(["vs/editor/editor.main"], function() {
      monaco.languages.register({ id: "lua" });
      monaco.languages.setMonarchTokensProvider("lua", { /* your tokenizer */ });
      monaco.editor.defineTheme("cravex-theme", { /* your theme */ });
      initializeProposals();

      monaco.languages.registerCompletionItemProvider("lua", {
        provideCompletionItems: (m, p) => {
          const w = m.getWordUntilPosition(p);
          const r = { startLineNumber: p.lineNumber, endLineNumber: p.lineNumber, startColumn: w.startColumn, endColumn: w.endColumn };
          return { suggestions: getDependencyProposals().map(p => ({ label: p.label, kind: p.kind, documentation: p.documentation, insertText: p.insertText, range: r, insertTextRules: p.insertTextRules })) };
        },
        triggerCharacters: [".", ":", "(", '"', "'", " ", "\t", ",", "{", "[", "="]
      });

      editor = monaco.editor.create(document.getElementById("container"), {
        value: "print('discord.gg/getcravex')",
        language: "lua",
        theme: "cravex-theme",
        fontSize: 14,
        minimap: { enabled: true },
        automaticLayout: true,
        scrollBeyondLastLine: false,
        roundedSelection: true,
        cursorBlinking: "smooth",
        cursorSmoothCaretAnimation: true,
        autoClosingBrackets: "never",
        autoClosingQuotes: "never",
        autoSurround: "never",
        autoIndent: "full",
        suggestOnTriggerCharacters: true
      });

      editor.onDidChangeModelContent(() => { if (activeTab) activeTab.content = editor.getValue(); saveTabsToLocalStorage(); });
      document.getElementById("new-tab-btn").onclick = createNewTab;
      loadTabsFromLocalStorage();
      window.onresize = () => editor.layout();
    });

    // Expose prefix function globally
    window.setTabPrefix = setTabPrefix;
  </script>
</body>
</html>
